# 友链页面HTML渲染问题修复记录

**修复时间**: 2026-01-06 12:18:53
**版本**: v2.1.0
**修复人员**: Claude + 哈基米

## 问题描述

### 严重错误：友链页面显示HTML源代码

**现象**: 友链页面从第2个友链开始，所有HTML都被转义显示为源代码

**表现**:
```html
正常显示：
<a class="friend-card" href="...">卡片内容</a>

错误显示（从第2个开始）：
&lt;a class=&quot;friend-card&quot; href=&quot;...&quot;&gt;卡片内容&lt;/a&gt;
```

**影响范围**:
- 从第2个友链（花生莲子粥）开始的所有卡片
- 共影响 16/17 个友链卡片
- 只有第1个友链（白夭夭）正常显示

## 根本原因分析

### Hugo Markdown 渲染机制问题

**问题根源**: Hugo 在处理 Markdown 文件中的 HTML 时，当遇到连续的 HTML 块时，会错误地将后续的 HTML 识别为代码块，并进行转义处理。

**触发条件**:
1. Markdown 文件中包含大量连续的 HTML 标签
2. HTML 块之间的空行不足
3. Hugo Goldmark 解析器的保守策略

**技术细节**:
```
第1个卡片: 正常渲染（在 ## 标题后，被视为段落内容）
第2个卡片: 被识别为代码块，转义显示
后续卡片: 同样被识别为代码块
```

## 解决方案

### 方案选择：使用 Hugo 短代码

**为什么选择短代码**:
1. ✅ 短代码中的 HTML 不会被 Markdown 解析器处理
2. ✅ 确保所有 HTML 都能正确渲染
3. ✅ 便于维护和复用
4. ✅ 避免 Markdown 解析的歧义

### 实施步骤

#### 1. 创建友链列表短代码

**文件**: `layouts/shortcodes/friends_list.html`

**内容**:
- 包含所有 17 个友链的完整 HTML
- 包含内联样式和脚本
- 包含三个分组标题

#### 2. 简化 friends.md

**修改前**:
```markdown
## 推荐友链

<div class="friend-section">
    <div class="friend-cards">
        <a class="friend-card" href="...">
        ...
        </a>
        <a class="friend-card" href="...">
        ...
        </a>
    </div>
</div>
```

**修改后**:
```markdown
## 推荐友链

{{< friends_list >}}
```

#### 3. 重启 Hugo 服务器

```bash
kill -9 $(lsof -ti:1313)
hugo server -D --bind 0.0.0.0 --port 1313
```

## 修复结果

### 修复前
```
第1个卡片: ✅ 正常显示
第2-17个卡片: ❌ HTML源代码
总计: 1/17 正常
```

### 修复后
```
所有 17 个卡片: ✅ 正常显示
总计: 17/17 正常
```

### 验证测试

```bash
curl -s http://localhost:1313/friends/ | grep -c "friend-card"
# 输出: 17
```

## 技术总结

### Hugo 短代码最佳实践

1. **大量HTML使用短代码**: 当需要在 Markdown 中插入大量 HTML 时，使用短代码避免解析问题
2. **内联样式和脚本**: 将相关样式和脚本放在短代码中，确保功能完整性
3. **文件组织**: 将可复用的 HTML 组件封装为短代码

### Markdown + HTML 混合注意事项

**可能导致问题的模式**:
```markdown
❌ 错误：连续的 HTML 块
<div>内容1</div>
<div>内容2</div>
<div>内容3</div>

✅ 正确：使用短代码
{{< component >}}
```

**安全模式**:
```markdown
✅ 第一个 HTML 块可以直接使用
<div>内容</div>

❌ 后续 HTML 块需要特殊处理
<div>更多内容</div>  ← 可能被转义
```

## 文件变更记录

### 新建文件
- `layouts/shortcodes/friends_list.html` (468行)

### 修改文件
- `content/friends.md` (从468行简化到12行)

### 删除内容
- 移除了 friends.md 中的所有内联 HTML
- 移除了内联样式和脚本

## 相关文档

### Hugo 官方文档
- [Shortcodes](https://gohugo.io/templates/shortcode-templates/)
- [Markdown Rendering](https://gohugo.io/content-management/formats/)

### 项目文档
- 原始设计: `/Code/PROD/web_server-website-refactor/`
- 数据文件: `content/friends/data.toml`
- 样式参考: `static/css/friends.css`

## 经验教训

### 1. Markdown 中大量 HTML 的风险
- ❌ 不推荐: 在 Markdown 文件中直接写大量 HTML
- ✅ 推荐: 使用 Hugo 短代码或自定义模板

### 2. 调试方法
- 使用 `curl` 检查实际渲染的 HTML
- 使用浏览器开发者工具查看 DOM 结构
- 检查 Hugo 服务器的输出日志

### 3. 开发流程
1. 先用少量 HTML 测试渲染
2. 确认无误后再添加完整内容
3. 遇到问题立即使用短代码方案

## 后续改进

- [ ] 考虑使用数据文件（JSON/YAML）存储友链信息
- [ ] 使用 Hugo Data Templates 动态生成友链
- [ ] 添加友链管理后台
- [ ] 实现友链分类和标签筛选

## 附录：完整友链列表

### 推荐友链 (4人)
1. 白夭夭 - 夭夭的博客
2. 花生莲子粥 - 花生莲子粥の小窝
3. 清羽飞扬 - 清羽飞扬的博客
4. EmulatedLab 论坛 - EmulatedLab官网

### UP主友友们 (3人)
5. 桃木雨 - Bilibili UP
6. 梨子Light - Bilibili UP
7. 江浙沪第一甜妹 - 微信公众号

### 开发者们 (2人)
8. NoneBot WebUI
9. Jack - 公益服主

---

**修复状态**: ✅ 已完成
**最后测试**: 2026-01-06 12:19:00
**Git 提交**: 待提交
