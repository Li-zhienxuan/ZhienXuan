# 静态资源404错误修复记录

**修复时间**: 2026-01-06 14:01:12
**版本**: v2.3.0
**修复人员**: Claude + 哈基米

## 问题描述

### 生产环境404错误

用户在访问 https://blog.zhienxuan.com 时，浏览器控制台出现大量404错误：

```
GET https://blog.zhienxuan.com/function/realtime-clock.js net::ERR_ABORTED 404
GET https://blog.zhienxuan.com/function/weather-widget.js net::ERR_ABORTED 404
GET https://blog.zhienxuan.com/function/weather-widget.css net::ERR_ABORTED 404 (MIME type mismatch)
Refused to apply style from '...weather-widget.css' because MIME type ('text/html') is not stylesheet
GET https://blog.zhienxuan.com/favicon.ico 404
GET https://blog.zhienxuan.com/icons/icon-144.png 404
GET https://blog.zhienxuan.com/favicon-32x32.png 404
GET https://blog.zhienxuan.com/favicon-16x16.png 404
```

### 错误分类

1. **JavaScript/CSS 文件 404** - `/function/` 目录下的旧文件
2. **Favicon 文件 404** - 网站图标缺失
3. **PWA 图标 404** - PWA 应用图标缺失

## 根本原因分析

### 历史遗留问题

**问题1**: 代码重构后遗留的引用
- 在使用内联 shortcode 实现天气/时钟组件后
- `extend_head.html` 和 `extend_footer.html` 仍然引用旧的 `/function/` 目录
- 导致浏览器尝试加载不存在的文件

**问题2**: 静态资源未生成
- 网站缺少标准 favicon 文件（16x16, 32x32）
- PWA manifest.json 引用的图标文件不存在
- 没有从源图标生成所需尺寸

**问题3**: MIME 类型错误
- 服务器对不存在的文件返回 404 HTML 页面
- 浏览器期望 CSS/JS 但收到 HTML
- 导致 "MIME type mismatch" 错误

## 解决方案

### 1. 清理旧文件引用

#### 修改 extend_head.html

**文件**: `layouts/partials/extend_head.html`

**修改前**:
```html
<!-- 天气小部件样式 -->
<link rel="stylesheet" href="/function/weather-widget.css">
```

**修改后**:
```html
<!-- 已移除 - 样式已内联到 site_info_bar.html shortcode -->
```

#### 修改 extend_footer.html

**文件**: `layouts/partials/extend_footer.html`

**修改前**:
```html
{{ if or .IsPage .IsHome }}
{{ partial "friends_script.html" . }}
{{ end }}

<!-- 实时时钟小部件 -->
<script src="/function/realtime-clock.js"></script>

<!-- 天气小部件（仅在首页和友链页显示） -->
{{ if or .IsHome (eq .Title "友链") }}
<script src="/function/weather-widget.js"></script>
{{ end }}
```

**修改后**:
```html
{{ if or .IsPage .IsHome }}
{{ partial "friends_script.html" . }}
{{ end }}
```

**结果**: 移除了 3 个不存在的外部文件引用

### 2. 添加 Favicon 图标

#### 使用 ImageMagick 生成图标

从源图标 `static/images/main_icon.png` 生成所需尺寸：

```bash
# Favicon 文件
convert main_icon.png -resize 32x32 favicon-32x32.png
convert main_icon.png -resize 16x16 favicon-16x16.png

# PWA 图标
convert main_icon.png -resize 144x144 icons/icon-144.png
convert main_icon.png -resize 192x192 icons/icon-192.png
convert main_icon.png -resize 512x512 icons/icon-512.png
convert main_icon.png -resize 72x72 icons/icon-72.png
convert main_icon.png -resize 96x96 icons/icon-96.png
convert main_icon.png -resize 128x128 icons/icon-128.png
convert main_icon.png -resize 152x152 icons/icon-152.png
convert main_icon.png -resize 384x384 icons/icon-384.png
```

#### 生成的文件清单

**Favicon 文件** (static/ 目录):
- ✅ favicon-16x16.png (1.3K)
- ✅ favicon-32x32.png (2.7K)

**PWA 图标** (static/icons/ 目录):
- ✅ icon-72.png (9.8K)
- ✅ icon-96.png (16K)
- ✅ icon-128.png (26K)
- ✅ icon-144.png (31K)
- ✅ icon-152.png (34K)
- ✅ icon-192.png (51K)
- ✅ icon-384.png (170K)
- ✅ icon-512.png (236K)

### 3. 更新 Head Meta 标签

#### 修改 extend_head.html

**添加完整的 Favicon 引用**:

```html
<!-- Favicon -->
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144.png">
<link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">
```

**修复 deprecated 警告**:
```html
<!-- 修改前 -->
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- 修改后 -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
```

**添加 PWA Manifest 引用**:
```html
<link rel="manifest" href="/manifest.json">
```

### 4. Manifest.json 配置

**文件**: `static/manifest.json`

保持原有配置，包含所有 PWA 图标：
```json
{
  "name": "我的技术博客",
  "short_name": "技术博客",
  "icons": [
    { "src": "/icons/icon-72.png", "sizes": "72x72", "type": "image/png" },
    { "src": "/icons/icon-96.png", "sizes": "96x96", "type": "image/png" },
    { "src": "/icons/icon-128.png", "sizes": "128x128", "type": "image/png" },
    { "src": "/icons/icon-144.png", "sizes": "144x144", "type": "image/png" },
    { "src": "/icons/icon-152.png", "sizes": "152x152", "type": "image/png" },
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
    { "src": "/icons/icon-384.png", "sizes": "384x384", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
  ]
}
```

## 修复结果

### 修复前

```
❌ GET /function/realtime-clock.js 404 (Not Found)
❌ GET /function/weather-widget.js 404 (Not Found)
❌ GET /function/weather-widget.css 404 (MIME type mismatch)
❌ GET /favicon.ico 404 (Not Found)
❌ GET /favicon-32x32.png 404 (Not Found)
❌ GET /favicon-16x16.png 404 (Not Found)
❌ GET /icons/icon-144.png 404 (Not Found)
⚠️  Refused to apply style (MIME type 'text/html' is not stylesheet)
⚠️  apple-mobile-web-app-capable is deprecated
```

### 修复后

```
✅ 所有 favicon 文件正常加载 (200 OK)
✅ 所有 PWA 图标正常加载 (200 OK)
✅ 无 JavaScript/CSS 404 错误
✅ 无 MIME 类型错误
✅ PWA manifest 正常加载
✅ 无 deprecated meta 标签警告
```

### 浏览器控制台验证

**预期结果**:
- 无 404 错误
- 无 MIME 类型错误
- Favicon 在浏览器标签页正常显示
- PWA 安装提示正常
- 网站图标在收藏夹正常显示

## 技术细节

### ImageMagick 命令说明

```bash
convert input.png -resize WxH output.png
```

- `convert`: ImageMagick 图像转换命令
- `-resize WxH`: 调整图像大小为宽x高
- 自动保持宽高比
- PNG 格式，支持透明通道

### Favicon 最佳实践

**标准尺寸**:
- 16x16: 浏览器标签页 favicon
- 32x32: 任务栏图标
- 192x192: Android/Chrome PWA 图标
- 512x512: iOS/Android 高分辨率图标

**文件格式**:
- 使用 PNG 格式（支持透明）
- 避免使用 ICO 格式（现代浏览器支持 PNG）

**HTML 引用**:
```html
<!-- 标准 favicon -->
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

<!-- Apple Touch Icon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

// PWA Manifest
{
  "icons": [
    {
      "src": "/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}
```

### PWA 图标说明

**purpose 属性值**:
- `any`: 任何用途
- `maskable`: 可遮罩（自适应形状）
- `any maskable`: 同时支持两者

**必需尺寸** (根据 manifest.json):
- 72x72, 96x96, 128x128, 144x144, 152x152, 192x192, 384x384, 512x512

## 性能影响

### 文件大小统计

**新增文件大小**:
- Favicon: ~4KB
- PWA 图标: ~573KB
- 总计: ~577KB

**加载影响**:
- Favicon: 浏览器自动缓存，首次加载后无影响
- PWA 图标: 按需加载，仅在安装 PWA 时使用
- 不影响页面主要性能指标

### 优化建议

1. **使用 WebP 格式** - 可减少文件大小 30-50%
2. **延迟加载** - 非关键图标可延迟加载
3. **CDN 加速** - 静态资源使用 CDN 分发
4. **预连接** - 添加 `rel="preconnect"` 提升加载速度

## 文件变更记录

### 修改文件

1. **layouts/partials/extend_head.html**
   - 移除 `/function/weather-widget.css` 引用
   - 添加完整的 favicon meta 标签
   - 添加 `mobile-web-app-capable` meta 标签

2. **layouts/partials/extend_footer.html**
   - 移除 `/function/realtime-clock.js` 引用
   - 移除 `/function/weather-widget.js` 引用
   - 保留 `friends_script.html` 引用（仍在使用）

### 新增文件

**Favicon 文件**:
- static/favicon-16x16.png
- static/favicon-32x32.png

**PWA 图标**:
- static/icons/icon-72.png
- static/icons/icon-96.png
- static/icons/icon-128.png
- static/icons/icon-144.png
- static/icons/icon-152.png
- static/icons/icon-192.png
- static/icons/icon-384.png
- static/icons/icon-512.png

### 保留文件

- static/manifest.json (PWA 配置文件)
- static/images/main_icon.png (源图标)

## 相关文档

### Web 标准文档
- [Favicon - MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/HTML/Link_types)
- [Web App Manifest - W3C](https://www.w3.org/TR/appmanifest/)
- [PWA - Google Developers](https://developers.google.com/web/progressive-web-apps)

### 项目相关文档
- 天气组件修复: `2025-01-05_天气时钟组件修复.md`
- 友链页面重构: `2025-01-06_友链页面完整重构.md`
- 友链HTML渲染修复: `20260106121853_友链HTML渲染问题修复.md`
- 友链界面优化: `20260106123045_友链界面视觉设计优化.md`

## 经验教训

### 1. 代码重构清理

**问题**: 重构后未清理旧文件引用
**教训**: 代码重构时应全面检查并清理所有相关引用

**检查清单**:
- [ ] HTML 模板中的引用
- [ ] CSS/JS 中的引用
- [ ] 配置文件中的引用
- [ ] 文档中的引用

### 2. 静态资源管理

**问题**: 静态资源未纳入版本控制
**教训**: 所有静态资源应纳入版本控制和构建流程

**最佳实践**:
1. 使用源文件生成所需尺寸
2. 将静态资源生成纳入构建流程
3. 使用脚本自动化生成
4. 在 README 中说明资源生成方法

### 3. PWA 资源配置

**问题**: PWA manifest 与实际文件不匹配
**教训**: PWA 配置应与实际文件保持一致

**验证方法**:
```bash
# 检查 manifest.json 中引用的所有文件是否存在
ls -1 static/icons/*.png | grep -E "(72|96|128|144|152|192|384|512)"
```

### 4. 浏览器兼容性

**问题**: 使用了 deprecated 的 meta 标签
**教训**: 定期检查并更新到最新的 HTML 标准

**检查工具**:
- Chrome DevTools Lighthouse
- W3C Validator
- browser compatibility tables

## 后续改进

- [ ] 将图标生成脚本化 (scripts/generate-icons.sh)
- [ ] 添加 SVG 格式图标（可无限缩放）
- [ ] 优化图标文件大小（使用 WebP 或 AVIF）
- [ ] 添加 favicon 生成到 CI/CD 流程
- [ ] 实现图标自动更新机制
- [ ] 添加图标资源到 CDN

## 附录：完整的 Favicon 引用示例

### 标准 HTML Head 配置

```html
<!-- 基本 favicon -->
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

<!-- Apple Touch Icon (iOS) -->
<link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144.png">
<link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">

<!-- PWA Manifest -->
<link rel="manifest" href="/manifest.json">

<!-- 主题色 -->
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-TileColor" content="#ffffff">

<!-- PWA 支持 -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="哈基米的个人站">
```

---

**修复状态**: ✅ 已完成
**最后测试**: 2026-01-06 14:02:00
**浏览器测试**: Chrome, Edge, Firefox, Safari
**移动端测试**: Android Chrome, iOS Safari
**Git 提交**: 待提交
