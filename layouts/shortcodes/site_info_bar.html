<div class="info-bar">
    <div class="info-item">
        <span class="info-icon">ğŸ“…</span>
        <span id="current-time">åŠ è½½ä¸­...</span>
    </div>

    <div class="info-item weather-info">
        <span class="info-icon" id="weather-icon">ğŸŒ¤ï¸</span>
        <div class="weather-details">
            <span id="weather-location">å®šä½ä¸­...</span>
            <span id="weather-desc"></span>
            <span id="weather-temp">--Â°C</span>
            <span id="visitor-ip" class="ip-display">IP: [é¼ æ ‡æ‚¬åœæ˜¾ç¤º]</span>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    const pad = n => String(n).padStart(2, '0');
    const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];

    function updateClock() {
        const d = new Date();
        const year = d.getFullYear();
        const month = pad(d.getMonth() + 1);
        const day = pad(d.getDate());
        const weekday = weekdays[d.getDay()];
        const hour = pad(d.getHours());
        const minute = pad(d.getMinutes());
        const second = pad(d.getSeconds());

        const el = document.getElementById('current-time');
        if (el) {
            el.textContent = `${year}-${month}-${day} ${weekday} ${hour}:${minute}:${second}`;
        }
    }

    updateClock();
    setInterval(updateClock, 1000);
})();
</script>

<script>
(function() {
    'use strict';

    const ipEl = document.getElementById('visitor-ip');
    const locEl = document.getElementById('weather-location');
    const tempEl = document.getElementById('weather-temp');
    const descEl = document.getElementById('weather-desc');
    const iconEl = document.getElementById('weather-icon');

    if (!ipEl && !locEl && !tempEl && !descEl && !iconEl) {
        return;
    }

    let realIp = null;

    const timeout = (ms) => new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), ms));
    const fetchJSON = (url, ms = 6000) => Promise.race([
        fetch(url).then(r => r.ok ? r.json() : Promise.reject(r)),
        timeout(ms)
    ]);

    function weatherCodeToText(code) {
        const codes = {
            0: 'æ™´æœ—', 1: 'æ™´æœ—', 2: 'æ™´æœ—', 3: 'å¤šäº‘',
            45: 'é›¾', 48: 'é›¾',
            51: 'å°é›¨', 53: 'å°é›¨', 55: 'å°é›¨',
            61: 'å°é›¨', 63: 'å°é›¨', 65: 'å°é›¨',
            71: 'å°é›ª', 73: 'å°é›ª', 75: 'å°é›ª', 77: 'å°é›ª',
            80: 'é˜µé›¨', 81: 'é˜µé›¨', 82: 'é˜µé›¨',
            95: 'é›·æš´', 96: 'é›·æš´', 99: 'é›·æš´'
        };
        return codes[code] || 'å¤©æ°”å¤šå˜';
    }

    function weatherCodeToEmoji(code) {
        const emojis = {
            0: 'â˜€ï¸', 1: 'â˜€ï¸', 2: 'â˜€ï¸', 3: 'â›…',
            45: 'ğŸŒ«ï¸', 48: 'ğŸŒ«ï¸',
            51: 'ğŸŒ§ï¸', 53: 'ğŸŒ§ï¸', 55: 'ğŸŒ§ï¸',
            61: 'ğŸŒ§ï¸', 63: 'ğŸŒ§ï¸', 65: 'ğŸŒ§ï¸',
            71: 'â„ï¸', 73: 'â„ï¸', 75: 'â„ï¸', 77: 'â„ï¸',
            80: 'ğŸŒ¦ï¸', 81: 'ğŸŒ¦ï¸', 82: 'ğŸŒ¦ï¸',
            95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
        };
        return emojis[code] || 'ğŸŒ¤ï¸';
    }

    async function getIpData() {
        const services = [
            'https://api.ip.sb/geoip',
            'https://ipapi.co/json/',
            'https://ipwho.is/json/'
        ];

        for (const url of services) {
            try {
                const d = await fetchJSON(url, 6000);
                if (d && (d.ip || d.ip_address || d.query)) {
                    console.log(`æˆåŠŸä» ${url} è·å–IPæ•°æ®`);
                    return {
                        ip: d.ip || d.ip_address || d.query,
                        city: d.city || '',
                        region: d.region || d.regionName || '',
                        country: d.country || d.country_name || d.countryCode || '',
                        lat: d.latitude ?? d.lat,
                        lon: d.longitude ?? d.lon
                    };
                }
            } catch (e) {
                console.warn(`IPæœåŠ¡ ${url} å¤±è´¥`);
            }
        }
        return null;
    }

    function updateIpDisplay(data) {
        const ip = data.ip || 'â€”';
        realIp = ip;

        if (ipEl) {
            ipEl.textContent = 'IP: [é¼ æ ‡æ‚¬åœæ˜¾ç¤º]';
            ipEl.style.cursor = 'pointer';
            ipEl.title = 'ç‚¹å‡»æˆ–æ‚¬åœæŸ¥çœ‹IP';

            ipEl.addEventListener('mouseenter', () => {
                ipEl.textContent = `IP: ${ip}`;
            });

            ipEl.addEventListener('mouseleave', () => {
                ipEl.textContent = 'IP: [é¼ æ ‡æ‚¬åœæ˜¾ç¤º]';
            });

            ipEl.addEventListener('click', (e) => {
                e.preventDefault();
                if (ipEl.textContent.includes('æ‚¬åœæ˜¾ç¤º')) {
                    ipEl.textContent = `IP: ${ip}`;
                } else {
                    ipEl.textContent = 'IP: [é¼ æ ‡æ‚¬åœæ˜¾ç¤º]';
                }
            });
        }

        const city = data.city || '';
        const region = data.region || data.regionName || '';
        const country = data.country_name || data.country || data.countryCode || '';
        const location = [city, region, country].filter(Boolean).join(' Â· ') || 'æœªçŸ¥ä½ç½®';
        if (locEl) {
            locEl.textContent = location;
        }
    }

    async function init() {
        try {
            const data = await getIpData();
            let lat = null, lon = null;

            if (data) {
                updateIpDisplay(data);
                lat = data.lat;
                lon = data.lon;
            } else {
                if (ipEl) {
                    ipEl.textContent = 'IP: æ— æ³•è·å–';
                }
                if (locEl) {
                    locEl.textContent = 'é»˜è®¤ä½ç½®';
                }
                lat = 31.2304;
                lon = 121.4737;
            }

            if (lat != null && lon != null) {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&timezone=auto`;

                try {
                    const w = await fetchJSON(url, 7000);
                    const cw = w.current_weather || {};
                    const temp = cw.temperature;
                    const code = cw.weathercode;
                    const wind = cw.windspeed;

                    if (tempEl) tempEl.textContent = (temp != null) ? `${Number(temp).toFixed(1)}Â°C` : '--Â°C';
                    if (descEl) descEl.textContent = `${weatherCodeToText(code)} Â· é£ ${wind ?? '--'} km/h`;
                    if (iconEl) iconEl.textContent = weatherCodeToEmoji(code);
                } catch (e) {
                    console.error('Weather API failed', e);
                    if (descEl) descEl.textContent = 'å¤©æ°”æœåŠ¡ä¸å¯ç”¨';
                }
            } else {
                if (descEl) descEl.textContent = 'æ— æ³•å®šä½';
                if (tempEl) tempEl.textContent = '--Â°C';
                if (iconEl) iconEl.textContent = 'â€”';
            }
        } catch (e) {
            console.error('Weather init failed', e);
            if (ipEl) ipEl.textContent = 'IP: æ— æ³•è·å–';
            if (locEl) locEl.textContent = 'æœªçŸ¥ä½ç½®';
            if (descEl) descEl.textContent = 'å¤©æ°”æœåŠ¡ä¸å¯ç”¨';
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>

<style>
.info-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
    padding: 15px 20px;
    margin-bottom: 30px;
    background: var(--card-bg, var(--entry-bg));
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    color: var(--text-color);
}

.info-icon {
    font-size: 1.2rem;
    line-height: 1;
}

.weather-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.weather-details {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.ip-display {
    font-size: 0.75rem;
    color: #7f8c8d;
    padding-left: 12px;
    border-left: 1px solid var(--border-color);
    cursor: pointer;
    transition: color 0.2s ease;
}

.ip-display:hover {
    color: var(--primary);
}

@media (max-width: 768px) {
    .info-bar {
        flex-direction: column;
        align-items: flex-start;
    }

    .weather-info {
        flex-wrap: wrap;
    }

    .ip-display {
        border-left: none;
        padding-left: 0;
    }
}
</style>
